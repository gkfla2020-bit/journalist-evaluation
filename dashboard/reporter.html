<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기자 상세 - KPI 시스템</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f5f5f5; font-family: 'Pretendard', -apple-system, sans-serif; }
        .container-main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .header { background: linear-gradient(135deg, #4487a1, #159895); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .profile-section { display: flex; align-items: center; gap: 1.5rem; }
        .profile-icon { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .card-header { background: #1a5f7a; color: white; font-weight: 600; border-radius: 12px 12px 0 0 !important; }
        .stat-box { background: #f8f9fa; border-radius: 8px; padding: 1rem; text-align: center; }
        .stat-box .value { font-size: 2rem; font-weight: 700; color: #1a5f7a; }
        .stat-box .label { font-size: 0.85rem; color: #6c757d; }
        .page-badge { display: inline-block; width: 32px; height: 32px; line-height: 32px; text-align: center; border-radius: 6px; font-weight: 700; font-size: 0.9rem; }
        .page-1 { background: #ffd700; color: #333; }
        .page-2-3 { background: #17a2b8; color: white; }
        .page-other { background: #6c757d; color: white; }
        .page-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 4px; margin: 1rem 0; }
        .page-cell { background: #e9ecef; border-radius: 4px; padding: 0.3rem; text-align: center; font-size: 0.7rem; font-weight: 600; }
        .page-cell.active { background: #1a5f7a; color: white; }
        .page-cell.highlight { background: #ffc107; color: #333; }
        .nav-tabs { border-bottom: 2px solid #1a5f7a; }
        .nav-tabs .nav-link { color: #1a5f7a; font-weight: 600; padding: 0.75rem 2rem; border: none; border-bottom: 3px solid transparent; margin-bottom: -2px; }
        .nav-tabs .nav-link:hover { border-color: transparent; background: #e8f4f8; }
        .nav-tabs .nav-link.active { color: white; background: #1a5f7a; border-bottom: 3px solid #ffc107; border-radius: 8px 8px 0 0; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .loading { text-align: center; padding: 3rem; color: #6c757d; }
        .edit-page i, .edit-chars i { pointer-events: none; }
        .nav-menu { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .nav-menu a { color: #1a5f7a; text-decoration: none; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 0.5rem; }
        .nav-menu a:hover { background: #1a5f7a; color: white; }
        .chart-container { position: relative; height: 200px; }
    </style>
</head>
<body>
<div class="container-main">

<!-- 토스트 메시지 -->
<div class="toast-container">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body"><i class="bi bi-check-circle me-2"></i>저장되었습니다</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- 네비게이션 -->
<div class="nav-menu" id="navMenu">
    <a href="home.html"><i class="bi bi-house-door me-1"></i>대시보드</a>
    <a href="list.html"><i class="bi bi-people me-1"></i>기자 목록</a>
    <span class="float-end">
        <small id="userInfo" class="me-2 text-muted"></small>
        <button class="btn btn-sm btn-outline-secondary" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 로그아웃</button>
    </span>
</div>

<!-- 헤더 -->
<div class="header">
    <div class="profile-section">
        <div class="profile-icon"><i class="bi bi-person-fill"></i></div>
        <div>
            <h1 style="font-size:1.8rem; margin-bottom:0.25rem;" id="reporterName">기자명</h1>
            <div style="opacity:0.9;" id="reporterDept">
                <span id="positionText">기자</span>
                <span id="editPositionBtn" style="cursor:pointer;" onclick="editPosition()" title="클릭하여 직위 수정">
                    <i class="bi bi-pencil-fill ms-1" style="font-size:0.7rem;"></i>
                </span>
            </div>
        </div>
        <div class="ms-auto text-end">
            <div class="small opacity-75">조회 기간</div>
            <div class="fw-bold" id="currentPeriod">-</div>
        </div>
    </div>
</div>

<!-- 기간 선택 탭 -->
<ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-period="daily" type="button">일별</button></li>
    <li class="nav-item"><button class="nav-link" data-period="weekly" type="button">주별</button></li>
    <li class="nav-item"><button class="nav-link" data-period="monthly" type="button">월별</button></li>
    <li class="nav-item"><button class="nav-link" data-period="quarterly" type="button">분기별</button></li>
    <li class="nav-item"><button class="nav-link" data-period="halfyear" type="button">반기별</button></li>
    <li class="nav-item"><button class="nav-link" data-period="all" type="button">전체</button></li>
</ul>

<!-- 날짜 네비게이션 -->
<div class="d-flex justify-content-center align-items-center mb-4" id="dateNav">
    <button class="btn btn-outline-secondary btn-sm me-3" id="prevBtn" onclick="navigatePeriod(-1)">
        <i class="bi bi-chevron-left"></i> 이전
    </button>
    <span class="fw-bold fs-5" id="navPeriodText">-</span>
    <button class="btn btn-outline-secondary btn-sm ms-3" id="nextBtn" onclick="navigatePeriod(1)">
        다음 <i class="bi bi-chevron-right"></i>
    </button>
</div>

<!-- 메인 컨텐츠 영역 -->
<div id="mainContent">
    <div class="loading"><i class="bi bi-arrow-repeat"></i> 데이터 로딩중...</div>
</div>

<!-- 하단 버튼 -->
<div class="d-flex justify-content-between mt-4" id="bottomButtons">
    <a href="list.html" class="btn btn-outline-secondary" id="backToListBtn"><i class="bi bi-arrow-left me-1"></i>기자 목록</a>
    <div>
        <button class="btn btn-success me-2" onclick="exportExcel()"><i class="bi bi-file-earmark-excel me-1"></i>엑셀</button>
        <button class="btn btn-primary" onclick="window.print()"><i class="bi bi-printer me-1"></i>인쇄</button>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
// 로그인 체크
const session = JSON.parse(localStorage.getItem('kpi_session') || 'null');
if (!session) {
    location.href = 'login.html';
}
const isAdmin = session && session.role === 'admin';
const isOwnPage = session && session.role === 'reporter';

// 기자 본인이면 네비게이션 숨기기 (대시보드/기자목록 접근 불가)
if (isOwnPage) {
    document.getElementById('navMenu').innerHTML = `
        <span class="text-muted"><i class="bi bi-person-circle me-1"></i>내 실적 조회</span>
        <span class="float-end">
            <small class="me-2 text-muted">${session.name}님</small>
            <button class="btn btn-sm btn-outline-secondary" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 로그아웃</button>
        </span>
    `;
    // 직위 수정 버튼 숨기기
    const editBtn = document.getElementById('editPositionBtn');
    if (editBtn) editBtn.style.display = 'none';
    // 하단 기자목록 버튼 숨기기
    const backBtn = document.getElementById('backToListBtn');
    if (backBtn) backBtn.style.display = 'none';
} else {
    document.getElementById('userInfo').textContent = session ? session.name + '님' : '';
}

function logout() {
    localStorage.removeItem('kpi_session');
    location.href = 'login.html';
}

// URL에서 기자명 가져오기
const urlParams = new URLSearchParams(window.location.search);
const reporterName = urlParams.get('name') || '';

// 기자 본인은 자기 페이지만 접근 가능
if (isOwnPage && reporterName !== session.name) {
    location.href = 'reporter.html?name=' + encodeURIComponent(session.name);
}

let currentPeriod = 'daily';
let allData = null;
let reporterData = null;
let selectedDate = new Date(); // 현재 선택된 날짜 (네비게이션용)

// localStorage 키
const STORAGE_KEY = 'kpi_evaluations';
const EVAL_API_URL = 'https://yyffk7tpfey7s2kv7hoitskxb40aljqw.lambda-url.us-east-1.on.aws/';

// 초기화
document.getElementById('reporterName').textContent = reporterName + ' 기자';
document.title = `기자 상세 - ${reporterName}`;

// 탭 클릭 이벤트
document.querySelectorAll('.nav-link').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        currentPeriod = this.dataset.period;
        selectedDate = new Date(); // 탭 변경시 오늘 날짜로 리셋
        renderContent();
        updateNavText();
    });
});

// 날짜 네비게이션
function navigatePeriod(direction) {
    switch (currentPeriod) {
        case 'daily':
            selectedDate.setDate(selectedDate.getDate() + direction);
            break;
        case 'weekly':
            selectedDate.setDate(selectedDate.getDate() + (direction * 7));
            break;
        case 'monthly':
            selectedDate.setMonth(selectedDate.getMonth() + direction);
            break;
        case 'quarterly':
            selectedDate.setMonth(selectedDate.getMonth() + (direction * 3));
            break;
        case 'halfyear':
            selectedDate.setMonth(selectedDate.getMonth() + (direction * 6));
            break;
    }
    renderContent();
    updateNavText();
}

// 네비게이션 텍스트 업데이트
function updateNavText() {
    document.getElementById('navPeriodText').textContent = getPeriodText();
    // 전체 탭일 때는 네비게이션 버튼 숨기기
    const dateNav = document.getElementById('dateNav');
    if (currentPeriod === 'all') {
        dateNav.querySelector('#prevBtn').style.display = 'none';
        dateNav.querySelector('#nextBtn').style.display = 'none';
    } else {
        dateNav.querySelector('#prevBtn').style.display = '';
        dateNav.querySelector('#nextBtn').style.display = '';
    }
}

// 데이터 로드
async function loadData() {
    document.getElementById('mainContent').innerHTML = '<div class="loading"><i class="bi bi-arrow-repeat"></i> 로딩중...</div>';
    
    try {
        const res = await fetch('data.json?t=' + Date.now());
        allData = await res.json();
        
        // 해당 기자 데이터 찾기
        reporterData = allData.reporters.find(r => r.name === reporterName);
        
        if (!reporterData) {
            document.getElementById('mainContent').innerHTML = '<div class="p-4 text-danger text-center">해당 기자를 찾을 수 없습니다. <a href="list.html">기자 목록</a>에서 선택해주세요.</div>';
            return;
        }
        
        // localStorage에서 저장된 평가 데이터 불러오기
        await loadSavedEvaluations();
        
        // 컨텐츠 렌더링
        renderContent();
        
    } catch (err) {
        console.error(err);
        document.getElementById('mainContent').innerHTML = '<div class="p-4 text-danger text-center">데이터 로드 실패</div>';
    }
}

// 서버에서 평가 데이터 불러오기
async function loadSavedEvaluations() {
    console.log('평가 데이터 로드 시작...');
    try {
        // 서버에서 먼저 불러오기 (캐시 방지)
        const url = EVAL_API_URL + '?t=' + Date.now();
        console.log('API 호출:', url);
        const res = await fetch(url);
        console.log('API 응답 상태:', res.status);
        if (res.ok) {
            const serverData = await res.json();
            console.log('서버 데이터:', serverData);
            // localStorage에도 동기화
            localStorage.setItem(STORAGE_KEY, JSON.stringify(serverData));
            // 기사에 적용
            let appliedCount = 0;
            reporterData.articles.forEach(article => {
                if (serverData[article.nsid]) {
                    Object.assign(article, serverData[article.nsid]);
                    appliedCount++;
                }
            });
            console.log('적용된 평가 수:', appliedCount);
            return;
        }
    } catch (e) {
        console.error('서버 데이터 로드 실패:', e);
    }
    
    // 서버 실패시 localStorage 사용
    console.log('localStorage에서 로드...');
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
        const evaluations = JSON.parse(saved);
        reporterData.articles.forEach(article => {
            if (evaluations[article.nsid]) {
                Object.assign(article, evaluations[article.nsid]);
            }
        });
    }
}

// 평가 데이터 저장 (localStorage + 서버)
async function saveEvaluation(nsid, data) {
    // localStorage에 저장
    const saved = localStorage.getItem(STORAGE_KEY);
    const evaluations = saved ? JSON.parse(saved) : {};
    evaluations[nsid] = { ...evaluations[nsid], ...data };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(evaluations));
    
    // 서버에도 저장
    try {
        const payload = {};
        payload[nsid] = evaluations[nsid];
        await fetch(EVAL_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (e) {
        console.log('서버 저장 실패:', e);
    }
}

// 통계만 업데이트 (테이블 다시 안 그림)
function updateStats() {
    const articles = getFilteredArticles();
    const stats = {
        article_count: articles.length,
        total_chars: articles.reduce((sum, a) => sum + (a.char_count || 0), 0),
        scoop_count: articles.filter(a => a.coverage_type === '특종').length,
        exclusive_count: articles.filter(a => a.coverage_type === '단독').length,
        s_grade: articles.filter(a => a.impact_grade === 'S').length,
        a_grade: articles.filter(a => a.impact_grade === 'A').length
    };
    
    // 상단 통계 카드 업데이트
    const statBoxes = document.querySelectorAll('.stat-box .value');
    if (statBoxes.length >= 6) {
        statBoxes[0].textContent = stats.article_count;
        statBoxes[1].textContent = stats.total_chars.toLocaleString();
        statBoxes[2].textContent = stats.scoop_count;
        statBoxes[3].textContent = stats.exclusive_count;
        statBoxes[4].textContent = stats.s_grade;
        statBoxes[5].textContent = stats.a_grade;
    }
}

// 컨텐츠 렌더링
function renderContent() {
    // 기간별 필터링 적용
    const articles = getFilteredArticles();
    
    // 조회 기간 표시 업데이트
    document.getElementById('currentPeriod').textContent = getPeriodText();
    document.getElementById('navPeriodText').textContent = getPeriodText();
    
    // 통계 계산
    const stats = {
        article_count: articles.length,
        total_chars: articles.reduce((sum, a) => sum + (a.char_count || 0), 0),
        front_page: articles.filter(a => a.paper_number === 1).length,
        page_2_3: articles.filter(a => a.paper_number >= 2 && a.paper_number <= 3).length,
        scoop_count: articles.filter(a => a.coverage_type === '특종').length,
        exclusive_count: articles.filter(a => a.coverage_type === '단독').length,
        s_grade: articles.filter(a => a.impact_grade === 'S').length,
        a_grade: articles.filter(a => a.impact_grade === 'A').length
    };
    
    // 면별 분포 계산
    const pageDistribution = {};
    for (let i = 1; i <= 32; i++) pageDistribution[i] = 0;
    articles.forEach(a => {
        if (a.paper_number >= 1 && a.paper_number <= 32) {
            pageDistribution[a.paper_number]++;
        }
    });
    
    let html = `
        <!-- KPI 요약 -->
        <div class="row g-3 mb-4">
            <div class="col-md-2"><div class="stat-box"><div class="value">${stats.article_count}</div><div class="label">기사건수</div></div></div>
            <div class="col-md-2"><div class="stat-box"><div class="value">${stats.total_chars.toLocaleString()}</div><div class="label">글자수</div></div></div>
            <div class="col-md-2"><div class="stat-box"><div class="value" style="color:#dc3545;">${stats.scoop_count}</div><div class="label">특종</div></div></div>
            <div class="col-md-2"><div class="stat-box"><div class="value" style="color:#fd7e14;">${stats.exclusive_count}</div><div class="label">단독</div></div></div>
            <div class="col-md-2"><div class="stat-box"><div class="value" style="color:#dc3545; font-weight:700;">${stats.s_grade}</div><div class="label">S등급</div></div></div>
            <div class="col-md-2"><div class="stat-box"><div class="value" style="color:#fd7e14;">${stats.a_grade}</div><div class="label">A등급</div></div></div>
        </div>
        
        <!-- 일별 기사수 추이 -->
        <div class="card">
            <div class="card-header"><i class="bi bi-graph-up me-2"></i>일별 기사수 추이 (최근 2주)</div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 면별 기사 분포 -->
        <div class="card">
            <div class="card-header"><i class="bi bi-grid-3x3 me-2"></i>면별 기사 분포 (1~32면)</div>
            <div class="card-body">
                <div class="page-grid mb-2">
                    ${renderPageGrid(pageDistribution, 1, 16)}
                </div>
                <div class="page-grid">
                    ${renderPageGrid(pageDistribution, 17, 32)}
                </div>
            </div>
        </div>
        
        <!-- 집계 테이블 -->
        <div class="card">
            <div class="card-header"><i class="bi bi-calendar-range me-2"></i>${getPeriodLabel()} 집계</div>
            <table class="table table-bordered mb-0">
                <thead class="table-dark">
                    <tr><th>기간</th><th>기사수</th><th>1면</th><th>2~3면</th><th>4면~</th><th>총글자수</th><th>평균</th><th>단독</th><th>기획</th></tr>
                </thead>
                <tbody>
                    <tr class="table-warning">
                        <td><strong>${getPeriodText()}</strong></td>
                        <td><strong>${stats.article_count}</strong></td>
                        <td>${stats.front_page > 0 ? '<span class="badge bg-warning text-dark">' + stats.front_page + '</span>' : '0'}</td>
                        <td>${stats.page_2_3}</td>
                        <td>${stats.article_count - stats.front_page - stats.page_2_3}</td>
                        <td>${stats.total_chars.toLocaleString()}</td>
                        <td>${stats.article_count > 0 ? Math.round(stats.total_chars / stats.article_count).toLocaleString() : 0}</td>
                        <td>${stats.exclusive_count > 0 ? '<span class="badge bg-success">' + stats.exclusive_count + '</span>' : '0'}</td>
                        <td>${stats.scoop_count > 0 ? '<span class="badge bg-info">' + stats.scoop_count + '</span>' : '0'}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 기사 목록 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-newspaper me-2"></i>기사 목록</span>
                <span class="badge bg-light text-dark">${articles.length}건</span>
            </div>
            <div class="card-body p-0">
                ${renderArticleTable(articles)}
            </div>
        </div>
    `;
    
    document.getElementById('mainContent').innerHTML = html;
    
    // 저장 버튼 이벤트 바인딩
    bindSaveEvents();
    
    // 일별 기사수 차트 렌더링
    renderDailyChart();
}

// 일별 기사수 차트 렌더링
let dailyChart = null;
function renderDailyChart() {
    if (!reporterData || !reporterData.articles) return;
    
    // 일별 집계
    const dailyCount = {};
    reporterData.articles.forEach(a => {
        const date = a.pub_date;
        if (date) {
            dailyCount[date] = (dailyCount[date] || 0) + 1;
        }
    });
    
    // 최근 14일 연속 날짜 생성
    const today = new Date();
    const allDates = [];
    for (let i = 13; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        allDates.push(d.toISOString().slice(0, 10));
    }
    
    const labels = allDates.map(d => {
        const dayOfWeek = new Date(d).getDay();
        const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
        return d.slice(5) + '(' + dayNames[dayOfWeek] + ')';
    });
    const data = allDates.map(d => dailyCount[d] || 0);
    
    // 일요일 표시용 배경색
    const bgColors = allDates.map(d => {
        const dayOfWeek = new Date(d).getDay();
        return dayOfWeek === 0 ? '#cccccc' : '#1a5f7a';
    });
    
    const ctx = document.getElementById('dailyChart');
    if (!ctx) return;
    
    if (dailyChart) dailyChart.destroy();
    
    dailyChart = new Chart(ctx.getContext('2d'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '기사수',
                data: data,
                backgroundColor: bgColors,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: { stepSize: 1 }
                }
            }
        }
    });
}

// 면별 그리드 렌더링
function renderPageGrid(dist, start, end) {
    let html = '';
    for (let i = start; i <= end; i++) {
        const count = dist[i] || 0;
        let cellClass = 'page-cell';
        if (i === 1 && count > 0) cellClass += ' highlight';
        else if (count > 0) cellClass += ' active';
        html += `<div class="${cellClass}">${i}면<br>${count > 0 ? '<b>' + count + '</b>' : '0'}</div>`;
    }
    return html;
}

// 기간 라벨
function getPeriodLabel() {
    const labels = { daily: '일별', weekly: '주별', monthly: '월별', quarterly: '분기별', halfyear: '반기별' };
    return labels[currentPeriod] || '기간별';
}

// 기간별 필터링된 기사 가져오기
function getFilteredArticles() {
    if (!reporterData || !reporterData.articles) return [];
    
    const articles = reporterData.articles;
    const baseDate = selectedDate;
    
    switch (currentPeriod) {
        case 'all':
            return articles;
        case 'daily': {
            const dateStr = formatDate(baseDate);
            console.log('Daily filter:', dateStr, 'period_end:', allData.period_end);
            return articles.filter(a => a.pub_date === dateStr);
        }
        case 'weekly': {
            const weekStart = new Date(baseDate);
            weekStart.setDate(baseDate.getDate() - baseDate.getDay()); // 일요일 시작
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return articles.filter(a => {
                const d = new Date(a.pub_date);
                return d >= weekStart && d <= weekEnd;
            });
        }
        case 'monthly': {
            const monthStr = `${baseDate.getFullYear()}-${String(baseDate.getMonth() + 1).padStart(2, '0')}`;
            return articles.filter(a => a.pub_date && a.pub_date.startsWith(monthStr));
        }
        case 'quarterly': {
            const quarter = Math.floor(baseDate.getMonth() / 3);
            const qStart = new Date(baseDate.getFullYear(), quarter * 3, 1);
            const qEnd = new Date(baseDate.getFullYear(), quarter * 3 + 3, 0);
            return articles.filter(a => {
                const d = new Date(a.pub_date);
                return d >= qStart && d <= qEnd;
            });
        }
        case 'halfyear': {
            const half = baseDate.getMonth() < 6 ? 0 : 1;
            const hStart = new Date(baseDate.getFullYear(), half * 6, 1);
            const hEnd = new Date(baseDate.getFullYear(), half * 6 + 6, 0);
            return articles.filter(a => {
                const d = new Date(a.pub_date);
                return d >= hStart && d <= hEnd;
            });
        }
        default:
            return articles;
    }
}

// 기간 텍스트 표시
function getPeriodText() {
    const baseDate = selectedDate;
    
    switch (currentPeriod) {
        case 'all':
            return allData.period_start + ' ~ ' + allData.period_end;
        case 'daily':
            return formatDate(baseDate);
        case 'weekly': {
            const weekStart = new Date(baseDate);
            weekStart.setDate(baseDate.getDate() - baseDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return `${formatDate(weekStart)} ~ ${formatDate(weekEnd)}`;
        }
        case 'monthly':
            return `${baseDate.getFullYear()}년 ${baseDate.getMonth() + 1}월`;
        case 'quarterly': {
            const quarter = Math.floor(baseDate.getMonth() / 3) + 1;
            return `${baseDate.getFullYear()}년 ${quarter}분기`;
        }
        case 'halfyear': {
            const half = baseDate.getMonth() < 6 ? '상반기' : '하반기';
            return `${baseDate.getFullYear()}년 ${half}`;
        }
        default:
            return allData.period_start + ' ~ ' + allData.period_end;
    }
}

// 날짜 포맷
function formatDate(d) {
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
}

// 기사 테이블 렌더링
function renderArticleTable(articles) {
    if (articles.length === 0) {
        return '<div class="p-4 text-muted text-center">기사가 없습니다</div>';
    }
    
    // 기자 본인은 평가 컬럼 숨김
    const showEvalCols = isAdmin;
    
    let html = `
        <table class="table table-hover mb-0" style="font-size:0.85rem;">
            <thead class="table-light">
                <tr>
                    <th style="width:10%">날짜</th>
                    <th style="width:${showEvalCols ? '26%' : '50%'}">제목</th>
                    <th style="width:8%">면</th>
                    <th style="width:10%">글자수</th>
                    ${showEvalCols ? `
                    <th style="width:10%">위치</th>
                    <th style="width:10%">취재유형</th>
                    <th style="width:10%">기사성격</th>
                    <th style="width:10%">임팩트</th>
                    <th style="width:6%">저장</th>
                    ` : ''}
                </tr>
            </thead>
            <tbody>
    `;
    
    articles.forEach(article => {
        const pageClass = article.paper_number == 1 ? 'page-1' : (article.paper_number <= 3 ? 'page-2-3' : 'page-other');
        const isHighlight = article.paper_number >= 1 && article.paper_number <= 3 ? 'style="background:#fffbeb;"' : '';
        const isSaved = article.impact_grade ? true : false;
        
        html += `
            <tr ${isHighlight} data-nsid="${article.nsid}">
                <td>${article.pub_date ? article.pub_date.slice(5) : '-'}</td>
                <td><a href="${article.url || '#'}" target="_blank" class="text-decoration-none fw-bold">${escapeHtml(article.title || '')}</a></td>
                <td><span class="page-badge ${pageClass}">${article.paper_number || '-'}</span>${showEvalCols ? ' <button type="button" class="btn btn-link btn-sm p-0 text-muted edit-page" title="수정"><i class="bi bi-pencil" style="font-size:0.7rem;"></i></button>' : ''}</td>
                <td>${article.char_count ? article.char_count.toLocaleString() : '-'}${showEvalCols ? ' <button type="button" class="btn btn-link btn-sm p-0 text-muted edit-chars" title="수정"><i class="bi bi-pencil" style="font-size:0.7rem;"></i></button>' : ''}</td>
                ${showEvalCols ? `
                <td>
                    <select class="form-select form-select-sm eval-position" style="width:85px;">
                        <option value="">선택</option>
                        <option value="톱(자동)" ${article.is_auto_top ? 'selected' : ''}>톱(자동)</option>
                        <option value="톱" ${!article.is_auto_top && article.position === '톱' ? 'selected' : ''}>톱</option>
                        <option value="사이드(좌)" ${article.position === '사이드(좌)' ? 'selected' : ''}>사이드(좌)</option>
                        <option value="사이드(우)" ${article.position === '사이드(우)' ? 'selected' : ''}>사이드(우)</option>
                        <option value="하단" ${article.position === '하단' ? 'selected' : ''}>하단</option>
                        <option value="기타" ${article.position === '기타' ? 'selected' : ''}>기타</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm eval-type" style="width:80px;">
                        <option value="">선택</option>
                        <option value="특종" ${article.coverage_type === '특종' ? 'selected' : ''}>특종</option>
                        <option value="단독" ${article.coverage_type === '단독' ? 'selected' : ''}>단독</option>
                        <option value="기획발굴" ${article.coverage_type === '기획발굴' ? 'selected' : ''}>기획발굴</option>
                        <option value="현장취재" ${article.coverage_type === '현장취재' ? 'selected' : ''}>현장취재</option>
                        <option value="단순발생" ${article.coverage_type === '단순발생' ? 'selected' : ''}>단순발생</option>
                        <option value="보도자료" ${article.coverage_type === '보도자료' ? 'selected' : ''}>보도자료</option>
                        <option value="인용외신" ${article.coverage_type === '인용외신' ? 'selected' : ''}>인용외신</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm eval-nature" style="width:80px;">
                        <option value="">선택</option>
                        <option value="탐사심층" ${article.article_nature === '탐사심층' ? 'selected' : ''}>탐사심층</option>
                        <option value="해설분석" ${article.article_nature === '해설분석' ? 'selected' : ''}>해설분석</option>
                        <option value="인터뷰" ${article.article_nature === '인터뷰' ? 'selected' : ''}>인터뷰</option>
                        <option value="르포스케치" ${article.article_nature === '르포스케치' ? 'selected' : ''}>르포스케치</option>
                        <option value="스트레이트" ${article.article_nature === '스트레이트' ? 'selected' : ''}>스트레이트</option>
                        <option value="가십미담" ${article.article_nature === '가십미담' ? 'selected' : ''}>가십미담</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm eval-impact" style="width:90px;">
                        <option value="">선택</option>
                        <option value="S" ${article.impact_grade === 'S' ? 'selected' : ''}>S등급</option>
                        <option value="A" ${article.impact_grade === 'A' ? 'selected' : ''}>A등급</option>
                        <option value="B" ${article.impact_grade === 'B' ? 'selected' : ''}>B등급</option>
                        <option value="C" ${article.impact_grade === 'C' ? 'selected' : ''}>C등급</option>
                        <option value="D" ${article.impact_grade === 'D' ? 'selected' : ''}>D등급</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-sm ${isSaved ? 'btn-success' : 'btn-outline-primary'} save-btn">
                        <i class="bi bi-${isSaved ? 'check2' : 'save'}"></i>
                    </button>
                ` : ''}
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    return html;
}
</script>

<script>
// 저장 버튼 이벤트 바인딩
function bindSaveEvents() {
    // 저장 버튼
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const row = this.closest('tr');
            const nsid = row.dataset.nsid;
            const saveBtn = this;
            
            const evalData = {
                position: row.querySelector('.eval-position').value,
                coverage_type: row.querySelector('.eval-type').value,
                article_nature: row.querySelector('.eval-nature').value,
                impact_grade: row.querySelector('.eval-impact').value
            };
            
            // 기자 데이터에 먼저 반영
            const article = reporterData.articles.find(a => a.nsid === nsid);
            if (article) {
                Object.assign(article, evalData);
            }
            
            // 서버에 저장
            await saveEvaluation(nsid, evalData);
            
            showToast('저장되었습니다');
            saveBtn.classList.remove('btn-outline-primary');
            saveBtn.classList.add('btn-success');
            saveBtn.innerHTML = '<i class="bi bi-check2"></i>';
            
            // 통계만 업데이트 (전체 렌더링 안함)
            updateStats();
        });
    });
    
    // 면 수정 버튼
    document.querySelectorAll('.edit-page').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const td = this.closest('td');
            const badge = td.querySelector('.page-badge');
            const currentVal = badge ? badge.textContent.trim() : '0';
            
            const originalHTML = td.innerHTML;
            td.innerHTML = `
                <input type="number" class="form-control form-control-sm d-inline-block" value="${currentVal === '-' ? 0 : currentVal}" style="width:50px;" min="0" max="32">
                <button type="button" class="btn btn-sm btn-success ms-1 edit-page-save"><i class="bi bi-check"></i></button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1 edit-page-cancel"><i class="bi bi-x"></i></button>
            `;
            td.dataset.originalHtml = originalHTML;
            td.querySelector('input').focus();
        });
    });
    
    // 글자수 수정 버튼
    document.querySelectorAll('.edit-chars').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const td = this.closest('td');
            const currentText = td.textContent.trim();
            const currentVal = currentText.replace(/[^0-9]/g, '') || '0';
            
            const originalHTML = td.innerHTML;
            td.innerHTML = `
                <input type="number" class="form-control form-control-sm d-inline-block" value="${currentVal}" style="width:80px;" min="0">
                <button type="button" class="btn btn-sm btn-success ms-1 edit-chars-save"><i class="bi bi-check"></i></button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1 edit-chars-cancel"><i class="bi bi-x"></i></button>
            `;
            td.dataset.originalHtml = originalHTML;
            td.querySelector('input').focus();
        });
    });
}

// 전역 클릭 이벤트 (동적 버튼용)
document.addEventListener('click', function(e) {
    // 면 수정 저장
    if (e.target.closest('.edit-page-save')) {
        const td = e.target.closest('td');
        const row = td.closest('tr');
        const nsid = row.dataset.nsid;
        const input = td.querySelector('input');
        const newVal = parseInt(input.value) || 0;
        
        // localStorage에 저장
        saveEvaluation(nsid, { paper_number: newVal });
        
        // 기자 데이터에도 반영
        const article = reporterData.articles.find(a => a.nsid === nsid);
        if (article) {
            article.paper_number = newVal;
        }
        
        const pageClass = newVal == 1 ? 'page-1' : (newVal <= 3 ? 'page-2-3' : 'page-other');
        td.innerHTML = `<span class="page-badge ${pageClass}">${newVal}</span> <button type="button" class="btn btn-link btn-sm p-0 text-muted edit-page" title="수정"><i class="bi bi-pencil" style="font-size:0.7rem;"></i></button>`;
        showToast('면이 수정되었습니다');
        bindSaveEvents();
        
        // 면별 분포 업데이트
        renderContent();
    }
    
    // 면 수정 취소
    if (e.target.closest('.edit-page-cancel')) {
        const td = e.target.closest('td');
        td.innerHTML = td.dataset.originalHtml || '';
        bindSaveEvents();
    }
    
    // 글자수 수정 저장
    if (e.target.closest('.edit-chars-save')) {
        const td = e.target.closest('td');
        const row = td.closest('tr');
        const nsid = row.dataset.nsid;
        const input = td.querySelector('input');
        const newVal = parseInt(input.value) || 0;
        
        // localStorage에 저장
        saveEvaluation(nsid, { char_count: newVal });
        
        // 기자 데이터에도 반영
        const article = reporterData.articles.find(a => a.nsid === nsid);
        if (article) {
            article.char_count = newVal;
        }
        
        td.innerHTML = `${newVal.toLocaleString()} <button type="button" class="btn btn-link btn-sm p-0 text-muted edit-chars" title="수정"><i class="bi bi-pencil" style="font-size:0.7rem;"></i></button>`;
        showToast('글자수가 수정되었습니다');
        bindSaveEvents();
        
        // 통계 업데이트
        renderContent();
    }
    
    // 글자수 수정 취소
    if (e.target.closest('.edit-chars-cancel')) {
        const td = e.target.closest('td');
        td.innerHTML = td.dataset.originalHtml || '';
        bindSaveEvents();
    }
});

// 토스트 표시
function showToast(message) {
    const toastEl = document.getElementById('saveToast');
    toastEl.querySelector('.toast-body').innerHTML = '<i class="bi bi-check-circle me-2"></i>' + message;
    const toast = new bootstrap.Toast(toastEl, { delay: 2000 });
    toast.show();
}

// HTML 이스케이프
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// 엑셀 내보내기
function exportExcel() {
    const articles = getFilteredArticles();
    if (articles.length === 0) {
        alert('내보낼 기사가 없습니다.');
        return;
    }
    
    // 엑셀 데이터 준비
    const excelData = articles.map((a, i) => ({
        '번호': i + 1,
        '날짜': a.pub_date || '',
        '제목': a.title || '',
        '면': a.paper_number || '',
        '글자수': a.char_count || 0,
        '위치': a.position || '',
        '취재유형': a.coverage_type || '',
        '기사성격': a.article_nature || '',
        '임팩트등급': a.impact_grade || '',
        'URL': a.url || ''
    }));
    
    // 통계 요약 행 추가
    const stats = {
        article_count: articles.length,
        total_chars: articles.reduce((sum, a) => sum + (a.char_count || 0), 0),
        scoop_count: articles.filter(a => a.coverage_type === '특종').length,
        exclusive_count: articles.filter(a => a.coverage_type === '단독').length,
        s_grade: articles.filter(a => a.impact_grade === 'S').length,
        a_grade: articles.filter(a => a.impact_grade === 'A').length
    };
    
    // 워크북 생성
    const wb = XLSX.utils.book_new();
    
    // 기사 목록 시트
    const ws = XLSX.utils.json_to_sheet(excelData);
    
    // 컬럼 너비 설정
    ws['!cols'] = [
        { wch: 5 },   // 번호
        { wch: 12 },  // 날짜
        { wch: 50 },  // 제목
        { wch: 5 },   // 면
        { wch: 8 },   // 글자수
        { wch: 10 },  // 위치
        { wch: 10 },  // 취재유형
        { wch: 10 },  // 기사성격
        { wch: 10 },  // 임팩트등급
        { wch: 40 }   // URL
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, '기사목록');
    
    // 요약 시트
    const summaryData = [
        { '항목': '기자명', '값': reporterName },
        { '항목': '조회기간', '값': getPeriodText() },
        { '항목': '기사건수', '값': stats.article_count },
        { '항목': '총글자수', '값': stats.total_chars },
        { '항목': '평균글자수', '값': stats.article_count > 0 ? Math.round(stats.total_chars / stats.article_count) : 0 },
        { '항목': '특종', '값': stats.scoop_count },
        { '항목': '단독', '값': stats.exclusive_count },
        { '항목': 'S등급', '값': stats.s_grade },
        { '항목': 'A등급', '값': stats.a_grade }
    ];
    const ws2 = XLSX.utils.json_to_sheet(summaryData);
    ws2['!cols'] = [{ wch: 15 }, { wch: 30 }];
    XLSX.utils.book_append_sheet(wb, ws2, '요약');
    
    // 파일명 생성
    const fileName = `${reporterName}_${getPeriodText().replace(/[~\s]/g, '_')}.xlsx`;
    
    // 다운로드
    XLSX.writeFile(wb, fileName);
    showToast('엑셀 파일이 다운로드되었습니다');
}

// 직위 수정
function editPosition() {
    const positions = ['기자', '선임기자', '차장', '부장', '국장', '논설위원', '대기자', '특파원'];
    const currentPos = document.getElementById('positionText').textContent;
    
    const select = document.createElement('select');
    select.className = 'form-select form-select-sm';
    select.style.cssText = 'width:120px; display:inline-block; background:rgba(255,255,255,0.9); color:#333;';
    
    positions.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        if (p === currentPos) opt.selected = true;
        select.appendChild(opt);
    });
    
    const container = document.getElementById('reporterDept');
    container.innerHTML = '';
    container.appendChild(select);
    
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-sm btn-light ms-2';
    saveBtn.innerHTML = '<i class="bi bi-check"></i>';
    saveBtn.onclick = async function(e) {
        e.stopPropagation();
        const newPos = select.value;
        
        // localStorage에 저장
        const posKey = 'kpi_positions';
        const saved = localStorage.getItem(posKey);
        const positionsData = saved ? JSON.parse(saved) : {};
        positionsData[reporterName] = newPos;
        localStorage.setItem(posKey, JSON.stringify(positionsData));
        
        // 서버에도 저장
        try {
            await fetch(EVAL_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ['position_' + reporterName]: { position: newPos } })
            });
        } catch (e) {
            console.log('직위 서버 저장 실패:', e);
        }
        
        container.innerHTML = `<span id="positionText">${newPos}</span><i class="bi bi-pencil-fill ms-1" style="font-size:0.7rem;"></i>`;
        container.onclick = editPosition;
        showToast('직위가 저장되었습니다');
    };
    container.appendChild(saveBtn);
    
    select.focus();
    container.onclick = null;
}

// 저장된 직위 불러오기
async function loadSavedPosition() {
    // 서버에서 먼저 불러오기
    try {
        const res = await fetch(EVAL_API_URL + '?t=' + Date.now());
        if (res.ok) {
            const serverData = await res.json();
            const posKey = 'position_' + reporterName;
            if (serverData[posKey] && serverData[posKey].position) {
                document.getElementById('positionText').textContent = serverData[posKey].position;
                return;
            }
        }
    } catch (e) {
        console.log('직위 서버 로드 실패:', e);
    }
    
    // 서버 실패시 localStorage
    const posKey = 'kpi_positions';
    const saved = localStorage.getItem(posKey);
    if (saved) {
        const positions = JSON.parse(saved);
        if (positions[reporterName]) {
            document.getElementById('positionText').textContent = positions[reporterName];
        }
    }
}

// 초기 로드
if (reporterName) {
    loadData();
    loadSavedPosition();
} else {
    document.getElementById('mainContent').innerHTML = '<div class="p-4 text-danger text-center">기자명이 지정되지 않았습니다. <a href="list.html">기자 목록</a>에서 선택해주세요.</div>';
}
</script>
</body>
</html>
