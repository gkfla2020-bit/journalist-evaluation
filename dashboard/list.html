<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>기자 목록 - KPI</title>
    <!-- Preconnect & Preload for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preload" href="data.json" as="fetch" crossorigin>
    <link rel="preload" href="users.json" as="fetch" crossorigin>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; font-family: 'Pretendard', -apple-system, sans-serif; }
        .container-main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .header { background: linear-gradient(135deg, #4487a1, #159895); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
        .card-header { background: #1a5f7a; color: white; font-weight: 600; border-radius: 12px 12px 0 0 !important; padding: 1rem 1.5rem; }
        .stat-card { background: white; border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; color: #1a5f7a; }
        .stat-card .label { font-size: 0.9rem; color: #6c757d; margin-top: 0.5rem; }
        .reporter-row { cursor: pointer; transition: background 0.2s; }
        .reporter-row:hover { background: #e8f4f8 !important; }
        .search-box { max-width: 300px; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .nav-menu { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .nav-menu a { color: #1a5f7a; text-decoration: none; padding: 0.5rem 1rem; border-radius: 8px; margin-right: 0.5rem; }
        .nav-menu a:hover, .nav-menu a.active { background: #1a5f7a; color: white; }
        .dept-badge { background: #e8f4f8; color: #1a5f7a; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { display: inline-block; animation: spin 1s linear infinite; }
    </style>
</head>
<body>
<div class="container-main">

<!-- 토스트 -->
<div class="toast-container">
    <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert">
        <div class="d-flex">
            <div class="toast-body" id="toastMsg"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<!-- 헤더 -->
<div class="header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 style="font-size:1.8rem; margin-bottom:0.25rem;"><i class="bi bi-bar-chart-fill me-2"></i>KPI</h1>
            <div style="opacity:0.9;">기자 지면 정보 정량평가 시스템</div>
        </div>
        <div class="text-end">
            <small id="userInfo" class="me-2"></small>
            <button class="btn btn-sm btn-outline-light" onclick="logout()"><i class="bi bi-box-arrow-right"></i> 로그아웃</button>
        </div>
    </div>
</div>

<!-- 네비게이션 -->
<div class="nav-menu" id="navMenu">
    <a href="home.html" id="navHome"><i class="bi bi-house-door me-1"></i>대시보드</a>
    <a href="list.html" class="active"><i class="bi bi-people me-1"></i>기자 목록</a>
    <a href="admin.html" id="navAdmin"><i class="bi bi-gear me-1"></i>사원 관리</a>
</div>

<!-- 부서 필터 (admin만 표시) -->
<div class="card mb-4" id="deptFilterCard" style="display:none;">
    <div class="card-body">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <label class="fw-bold text-nowrap me-2">부서 선택</label>
            <select class="form-select" id="deptSelect" style="width:200px;" onchange="filterByDept()">
                <option value="">전체 부서</option>
            </select>
            <span class="dept-badge" id="currentDept">전체</span>
        </div>
    </div>
</div>

<!-- 기간 선택 & 동기화 -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <label class="fw-bold text-nowrap me-2">조회 기간</label>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="setPeriod('all', this)">전체</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setPeriod('daily', this)">일별</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setPeriod('weekly', this)">주별</button>
                        <button type="button" class="btn btn-outline-primary" onclick="setPeriod('monthly', this)">월별</button>
                    </div>
                    <div id="periodNav" class="d-flex align-items-center gap-2 ms-3" style="display:none;"></div>
                </div>
            </div>
            <div class="col-md-4 text-end" id="syncBtnArea">
                <button class="btn btn-outline-success" id="syncBtn" onclick="syncData()">
                    <i class="bi bi-cloud-download me-1"></i>데이터 동기화
                </button>
            </div>
        </div>
        <div class="mt-2">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                데이터 기간: <span id="dataRange">-</span> | 
                마지막 동기화: <span id="lastSyncTime">-</span>
            </small>
        </div>
    </div>
</div>

<!-- 요약 통계 -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="value" id="stat-articles">-</div>
            <div class="label">총 기사 수</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="value" id="stat-reporters">-</div>
            <div class="label">기자 수</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="value" id="stat-evaluated">0</div>
            <div class="label">평가 완료</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="value" id="stat-period">-</div>
            <div class="label">데이터 기간</div>
        </div>
    </div>
</div>

<!-- 기자 목록 -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people-fill me-2"></i>기자 목록 <span id="deptTitle"></span></span>
        <div class="d-flex gap-2 align-items-center">
            <input type="text" class="form-control form-control-sm search-box" id="searchInput" placeholder="기자명 검색...">
            <span class="badge bg-light text-dark" id="reporterCount">0명</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:5%">#</th>
                        <th style="width:15%">기자명</th>
                        <th style="width:15%" id="deptCol">부서</th>
                        <th style="width:12%">기사 수</th>
                        <th style="width:15%">총 글자수</th>
                        <th style="width:15%">평균 글자수</th>
                        <th style="width:13%">상세</th>
                    </tr>
                </thead>
                <tbody id="reporterList">
                    <tr><td colspan="7" class="text-center py-4 text-muted">데이터 로딩중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 하단 버튼 -->
<div class="d-flex justify-content-between mt-4">
    <div></div>
    <button class="btn btn-success" onclick="exportExcel()">
        <i class="bi bi-file-earmark-excel me-1"></i>엑셀 내보내기
    </button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
<script>
// 로그인 체크
const session = JSON.parse(localStorage.getItem('kpi_session') || 'null');
if (!session) {
    location.href = 'login.html';
}

// 세션 만료 체크 (24시간)
if (session && session.loginTime) {
    const loginTime = new Date(session.loginTime);
    const now = new Date();
    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
    if (hoursDiff > 24) {
        localStorage.removeItem('kpi_session');
        alert('세션이 만료되었습니다. 다시 로그인해주세요.');
        location.href = 'login.html';
    }
}

// 권한 체크: admin 또는 manager만 접근 가능
if (session.role !== 'admin' && session.role !== 'manager') {
    alert('접근 권한이 없습니다.');
    location.href = 'login.html';
}

document.getElementById('userInfo').textContent = session ? `${session.name}님 (${session.role === 'admin' ? '관리자' : session.department})` : '';

// manager는 대시보드, 사원관리 링크 숨김
if (session.role === 'manager') {
    document.getElementById('navHome').style.display = 'none';
    document.getElementById('navAdmin').style.display = 'none';
}

function logout() {
    localStorage.removeItem('kpi_session');
    location.href = 'login.html';
}

let allData = null;
let usersData = [];
let evaluationsData = {};
let currentPeriod = 'all';
let selectedDate = new Date();
let selectedDept = '';

const EVAL_API_URL = 'https://yyffk7tpfey7s2kv7hoitskxb40aljqw.lambda-url.us-east-1.on.aws/';

// URL에서 부서 파라미터 확인
const urlParams = new URLSearchParams(window.location.search);
const deptParam = urlParams.get('dept');

// 초기 로드 - 병렬 로딩으로 속도 개선
document.addEventListener('DOMContentLoaded', async () => {
    // 병렬로 데이터 로드 (Promise.allSettled로 하나 실패해도 계속 진행)
    const [usersResult, evalResult] = await Promise.allSettled([
        fetch('users.json?t=' + Date.now()).then(r => r.json()),
        fetch(EVAL_API_URL + '?t=' + Date.now()).then(r => r.ok ? r.json() : {})
    ]);
    
    if (usersResult.status === 'fulfilled') usersData = usersResult.value;
    if (evalResult.status === 'fulfilled') evaluationsData = evalResult.value;
    
    // admin이면 부서 필터 표시
    if (session.role === 'admin') {
        document.getElementById('deptFilterCard').style.display = 'block';
        populateDeptSelect();
    } else if (session.role === 'manager') {
        // manager는 자기 부서만
        selectedDept = session.department;
        document.getElementById('currentDept').textContent = selectedDept;
        document.getElementById('deptTitle').textContent = `- ${selectedDept}`;
        document.getElementById('syncBtnArea').style.display = 'none'; // 동기화 버튼 숨김
    }
    
    // URL 파라미터로 부서 지정된 경우
    if (deptParam) {
        selectedDept = deptParam;
        document.getElementById('deptSelect').value = deptParam;
        document.getElementById('currentDept').textContent = deptParam;
        document.getElementById('deptTitle').textContent = `- ${deptParam}`;
    }
    
    loadData();
});

// 부서 선택 옵션 채우기
function populateDeptSelect() {
    const depts = [...new Set(usersData.map(u => u.department).filter(d => d && d !== '전체'))];
    depts.sort();
    const select = document.getElementById('deptSelect');
    depts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        select.appendChild(opt);
    });
}

// 부서 필터
function filterByDept() {
    selectedDept = document.getElementById('deptSelect').value;
    document.getElementById('currentDept').textContent = selectedDept || '전체';
    document.getElementById('deptTitle').textContent = selectedDept ? `- ${selectedDept}` : '';
    updateView(null);
}

// 데이터 로드
async function loadData() {
    try {
        const res = await fetch('data.json?t=' + Date.now());
        allData = await res.json();
        
        document.getElementById('dataRange').textContent = `${allData.period_start} ~ ${allData.period_end}`;
        document.getElementById('lastSyncTime').textContent = allData.last_sync;
        
        selectedDate = new Date();
        updateView();
        
        const searchInput = document.getElementById('searchInput');
        searchInput.removeEventListener('input', handleSearch);
        searchInput.addEventListener('input', handleSearch);
    } catch (err) {
        console.error(err);
        document.getElementById('reporterList').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">데이터 로드 실패</td></tr>';
    }
}

// 기간 설정
function setPeriod(period, btn) {
    currentPeriod = period;
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updatePeriodNav();
    updateView(null);
}

// 기간 네비게이션 UI
function updatePeriodNav() {
    const nav = document.getElementById('periodNav');
    if (currentPeriod === 'all') {
        nav.style.display = 'none';
        return;
    }
    nav.style.display = 'flex';
    
    if (currentPeriod === 'daily') {
        nav.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary" onclick="moveDate(-1)"><i class="bi bi-chevron-left"></i></button>
            <input type="date" class="form-control form-control-sm" value="${formatDate(selectedDate)}" style="width:150px;" onchange="setDateFromInput(this.value)">
            <button class="btn btn-sm btn-outline-secondary" onclick="moveDate(1)"><i class="bi bi-chevron-right"></i></button>
            <span class="ms-2 fw-bold">${formatDateKR(selectedDate)}</span>
        `;
    } else if (currentPeriod === 'weekly') {
        const ws = getWeekStart(selectedDate);
        const we = new Date(ws); we.setDate(ws.getDate() + 6);
        nav.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary" onclick="moveDate(-7)"><i class="bi bi-chevron-left"></i> 이전주</button>
            <span class="mx-3 fw-bold">${formatDate(ws)} ~ ${formatDate(we)}</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="moveDate(7)">다음주 <i class="bi bi-chevron-right"></i></button>
        `;
    } else if (currentPeriod === 'monthly') {
        nav.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary" onclick="moveMonth(-1)"><i class="bi bi-chevron-left"></i> 이전달</button>
            <span class="mx-3 fw-bold">${selectedDate.getFullYear()}년 ${selectedDate.getMonth()+1}월</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="moveMonth(1)">다음달 <i class="bi bi-chevron-right"></i></button>
        `;
    }
}

// 날짜 입력 유효성 검사
function setDateFromInput(value) {
    if (!value) return;
    const newDate = new Date(value);
    if (isNaN(newDate.getTime())) {
        alert('유효하지 않은 날짜입니다.');
        return;
    }
    selectedDate = newDate;
    updatePeriodNav();
    updateView(null);
}

// 뷰 업데이트
function updateView(searchKeyword = null) {
    if (searchKeyword === null) {
        searchKeyword = document.getElementById('searchInput').value;
    }
    const filtered = getFilteredData(searchKeyword);
    
    const totalArticles = filtered.reduce((s, r) => s + r.article_count, 0);
    document.getElementById('stat-articles').textContent = totalArticles;
    document.getElementById('stat-reporters').textContent = filtered.length;
    document.getElementById('reporterCount').textContent = filtered.length + '명';
    
    // 평가 완료 수 계산
    const evaluatedCount = Object.keys(evaluationsData).filter(nsid => 
        evaluationsData[nsid] && evaluationsData[nsid].impact_grade
    ).length;
    document.getElementById('stat-evaluated').textContent = evaluatedCount;
    
    let periodText = `${allData.period_start.slice(5)} ~ ${allData.period_end.slice(5)}`;
    if (currentPeriod === 'daily') periodText = formatDate(selectedDate).slice(5);
    else if (currentPeriod === 'weekly') {
        const ws = getWeekStart(selectedDate);
        const we = new Date(ws); we.setDate(ws.getDate() + 6);
        periodText = `${formatDate(ws).slice(5)} ~ ${formatDate(we).slice(5)}`;
    } else if (currentPeriod === 'monthly') periodText = `${selectedDate.getMonth()+1}월`;
    document.getElementById('stat-period').textContent = periodText;
    
    renderTable(filtered);
}

// 필터링된 데이터
function getFilteredData(searchKeyword = '') {
    if (!allData) return [];
    
    let articles = allData.reporters.flatMap(r => r.articles || []);
    
    // 기간 필터
    if (currentPeriod === 'daily') {
        const ds = formatDate(selectedDate);
        articles = articles.filter(a => a.pub_date === ds);
    } else if (currentPeriod === 'weekly') {
        const ws = getWeekStart(selectedDate);
        const we = new Date(ws); we.setDate(ws.getDate() + 6);
        articles = articles.filter(a => {
            const d = new Date(a.pub_date);
            return d >= ws && d <= we;
        });
    } else if (currentPeriod === 'monthly') {
        const ms = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}`;
        articles = articles.filter(a => a.pub_date && a.pub_date.startsWith(ms));
    }
    
    // 기자별 재집계
    const map = {};
    articles.forEach(a => {
        const n = a.reporter_name;
        if (!map[n]) map[n] = { name: n, articles: [], total_chars: 0 };
        map[n].articles.push(a);
        map[n].total_chars += a.char_count || 0;
    });
    
    let result = Object.values(map).map(r => {
        // 사용자 데이터에서 부서 찾기
        const userInfo = usersData.find(u => u.name === r.name);
        return {
            name: r.name,
            department: userInfo ? userInfo.department : '-',
            article_count: r.articles.length,
            total_chars: r.total_chars,
            avg_chars: r.articles.length > 0 ? Math.round(r.total_chars / r.articles.length) : 0
        };
    });
    
    // 부서 필터
    if (selectedDept) {
        result = result.filter(r => r.department === selectedDept);
    }
    
    // 검색
    if (searchKeyword) {
        const kw = searchKeyword.toLowerCase();
        result = result.filter(r => r.name.toLowerCase().includes(kw));
    }
    
    return result.sort((a, b) => b.article_count - a.article_count);
}

// 테이블 렌더링
function renderTable(reporters) {
    const tbody = document.getElementById('reporterList');
    if (reporters.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">해당 기간에 기사가 없습니다</td></tr>';
        return;
    }
    tbody.innerHTML = reporters.map((r, i) => `
        <tr class="reporter-row" onclick="location.href='reporter.html?name=${encodeURIComponent(r.name)}'">
            <td>${i + 1}</td>
            <td><strong>${escapeHtml(r.name)}</strong></td>
            <td><span class="dept-badge">${escapeHtml(r.department)}</span></td>
            <td>${r.article_count}</td>
            <td>${r.total_chars.toLocaleString()}</td>
            <td>${r.avg_chars.toLocaleString()}</td>
            <td><button class="btn btn-sm btn-outline-primary">상세보기</button></td>
        </tr>
    `).join('');
}

// 날짜 이동
function moveDate(days) {
    selectedDate.setDate(selectedDate.getDate() + days);
    updatePeriodNav();
    updateView(null);
}
function moveMonth(m) {
    selectedDate.setMonth(selectedDate.getMonth() + m);
    updatePeriodNav();
    updateView(null);
}

// 유틸
function formatDate(d) {
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function formatDateKR(d) {
    const days = ['일','월','화','수','목','금','토'];
    return `${d.getFullYear()}년 ${d.getMonth()+1}월 ${d.getDate()}일 (${days[d.getDay()]})`;
}
function getWeekStart(d) {
    const r = new Date(d);
    r.setDate(r.getDate() - r.getDay());
    return r;
}
function escapeHtml(t) {
    const d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

// 동기화
async function syncData() {
    const btn = document.getElementById('syncBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-repeat spin me-1"></i>동기화 중...';
    try {
        const res = await fetch('https://3pxmyosj2eunachemenbx4b6ay0dzqvd.lambda-url.us-east-1.on.aws/');
        const result = await res.json();
        if (result.success) {
            showToast(`동기화 완료! ${result.total_articles}건`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('동기화 실패: ' + (result.error || '오류'), 'danger');
        }
    } catch (e) {
        showToast('동기화 실패: 네트워크 오류', 'danger');
    }
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-cloud-download me-1"></i>데이터 동기화';
}

function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.className = `toast align-items-center text-bg-${type} border-0`;
    document.getElementById('toastMsg').textContent = msg;
    new bootstrap.Toast(t).show();
}

function handleSearch() {
    updateView(this.value);
}

// 엑셀 내보내기
function exportExcel() {
    const reporters = getFilteredData(document.getElementById('searchInput').value);
    if (reporters.length === 0) {
        alert('내보낼 데이터가 없습니다.');
        return;
    }
    
    const reporterData = reporters.map((r, i) => ({
        '순위': i + 1,
        '기자명': r.name,
        '부서': r.department,
        '기사수': r.article_count,
        '총글자수': r.total_chars,
        '평균글자수': r.avg_chars
    }));
    
    let periodText = `${allData.period_start} ~ ${allData.period_end}`;
    if (currentPeriod === 'daily') periodText = formatDate(selectedDate);
    else if (currentPeriod === 'weekly') {
        const ws = getWeekStart(selectedDate);
        const we = new Date(ws); we.setDate(ws.getDate() + 6);
        periodText = `${formatDate(ws)} ~ ${formatDate(we)}`;
    } else if (currentPeriod === 'monthly') periodText = `${selectedDate.getFullYear()}년 ${selectedDate.getMonth()+1}월`;
    
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(reporterData);
    ws['!cols'] = [{ wch: 6 }, { wch: 15 }, { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 12 }];
    XLSX.utils.book_append_sheet(wb, ws, '기자목록');
    
    const fileName = `기자목록_${selectedDept || '전체'}_${periodText.replace(/[~\s]/g, '_')}.xlsx`;
    XLSX.writeFile(wb, fileName);
    showToast('엑셀 파일이 다운로드되었습니다', 'success');
}
</script>
</body>
</html>
